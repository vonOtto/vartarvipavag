{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "På Spåret Party Edition - Events v1.3.0",
  "description": "WebSocket event schemas for Sprint 1 (game flow), Sprint 1.1 (audio), Sprint 1.2 (follow-up questions), and Sprint 1.3 (TTS voice)",

  "definitions": {
    "Envelope": {
      "type": "object",
      "description": "Base envelope for all events",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "type": "string" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer", "description": "Server monotonic time in milliseconds" },
        "payload": { "type": "object" }
      },
      "additionalProperties": false
    },

    "Role": {
      "type": "string",
      "enum": ["HOST", "PLAYER", "TV"],
      "description": "Client role type"
    }
  },

  "oneOf": [
    {
      "title": "HELLO",
      "description": "Client → Server: Initial connection handshake",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "HELLO" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["role", "authToken", "clientVersion"],
          "properties": {
            "role": { "$ref": "#/definitions/Role" },
            "authToken": { "type": "string", "description": "Session join code or host token" },
            "clientVersion": { "type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$" },
            "deviceId": { "type": "string", "description": "Optional persistent device ID for reconnect" },
            "playerName": { "type": "string", "description": "Required for PLAYER role" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "WELCOME",
      "description": "Server → Client: Connection confirmed",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "WELCOME" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["connectionId", "role", "playerId"],
          "properties": {
            "connectionId": { "type": "string" },
            "role": { "$ref": "#/definitions/Role" },
            "playerId": { "type": "string", "description": "Assigned player ID" },
            "serverTimeMs": { "type": "integer", "description": "Server time for sync calculation" },
            "timeOffsetHintMs": { "type": "integer", "description": "Hint for client to calculate RTT" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "RESUME_SESSION",
      "description": "Client → Server: Reconnect to existing session",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "RESUME_SESSION" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["playerId", "lastReceivedEventId"],
          "properties": {
            "playerId": { "type": "string" },
            "lastReceivedEventId": { "type": "string", "description": "Last event ID received before disconnect" },
            "deviceId": { "type": "string" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "STATE_SNAPSHOT",
      "description": "Server → Client: Full state sync on join/reconnect",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "STATE_SNAPSHOT" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["state"],
          "properties": {
            "state": { "$ref": "state.schema.json" },
            "missedEvents": {
              "type": "array",
              "description": "Events missed during disconnect (for reconnect)",
              "items": { "$ref": "#/definitions/Envelope" }
            }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "PLAYER_JOINED",
      "description": "Server → All: New player joined the session",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "PLAYER_JOINED" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["playerId", "name", "joinedAtMs"],
          "properties": {
            "playerId": { "type": "string" },
            "name": { "type": "string" },
            "joinedAtMs": { "type": "integer" },
            "isReconnect": { "type": "boolean", "default": false }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "PLAYER_LEFT",
      "description": "Server → All: Player disconnected",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "PLAYER_LEFT" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["playerId", "reason"],
          "properties": {
            "playerId": { "type": "string" },
            "reason": { "type": "string", "enum": ["disconnect", "kicked", "timeout"] }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "LOBBY_UPDATED",
      "description": "Server → All: Full lobby state update",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "LOBBY_UPDATED" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["players", "joinCode"],
          "properties": {
            "players": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["playerId", "name", "isConnected"],
                "properties": {
                  "playerId": { "type": "string" },
                  "name": { "type": "string" },
                  "isConnected": { "type": "boolean" }
                }
              }
            },
            "joinCode": { "type": "string" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "HOST_START_GAME",
      "description": "Host → Server: Start the game",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "HOST_START_GAME" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "properties": {
            "confirmedPlayers": {
              "type": "array",
              "description": "Optional list of player IDs to include",
              "items": { "type": "string" }
            }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "CLUE_PRESENT",
      "description": "Server → All: Present new clue level",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "CLUE_PRESENT" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["clueText", "clueLevelPoints", "roundIndex"],
          "properties": {
            "clueText": { "type": "string" },
            "clueLevelPoints": { "type": "integer", "enum": [10, 8, 6, 4, 2] },
            "roundIndex": { "type": "integer" },
            "clueIndex": { "type": "integer", "description": "0-indexed clue within round" },
            "textRevealAfterMs": { "type": "integer", "minimum": 0, "description": "Delay in ms before clueText should be shown on screen. Equal to the TTS clip durationMs when a voice clip is available; 0 when TTS is unavailable (text shown immediately). Clients use this as a pure display delay — not game logic. Absent or 0 means show immediately." }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "CLUE_ADVANCE",
      "description": "Server → All: Auto-advance to next clue level",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "CLUE_ADVANCE" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["nextClueLevelPoints"],
          "properties": {
            "nextClueLevelPoints": { "type": "integer", "enum": [10, 8, 6, 4, 2] },
            "advanceInMs": { "type": "integer", "description": "Time until next clue presents (for UI countdown)" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "BRAKE_PULL",
      "description": "Player → Server: Player hits brake button",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "BRAKE_PULL" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["playerId", "clientTimeMs"],
          "properties": {
            "playerId": { "type": "string" },
            "clientTimeMs": { "type": "integer", "description": "Client's local time for latency calculation" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "BRAKE_ACCEPTED",
      "description": "Server → All: Brake accepted, game paused",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "BRAKE_ACCEPTED" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["playerId", "playerName", "clueLevelPoints"],
          "properties": {
            "playerId": { "type": "string" },
            "playerName": { "type": "string" },
            "clueLevelPoints": { "type": "integer", "enum": [10, 8, 6, 4, 2] },
            "answerTimeoutMs": { "type": "integer", "description": "Time allowed for answer submission" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "BRAKE_REJECTED",
      "description": "Server → Player: Brake rejected (too late or rate limited)",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "BRAKE_REJECTED" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["playerId", "reason"],
          "properties": {
            "playerId": { "type": "string" },
            "reason": { "type": "string", "enum": ["too_late", "rate_limited", "already_paused", "invalid_phase"] },
            "winnerPlayerId": { "type": "string", "description": "Who won the brake race (if too_late)" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "BRAKE_ANSWER_SUBMIT",
      "description": "Brake owner → Server: Submit destination answer",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "BRAKE_ANSWER_SUBMIT" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["playerId", "answerText"],
          "properties": {
            "playerId": { "type": "string" },
            "answerText": { "type": "string", "minLength": 1, "maxLength": 200 }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "BRAKE_ANSWER_LOCKED",
      "description": "Server → All: Answer has been locked",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "BRAKE_ANSWER_LOCKED" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["playerId", "lockedAtLevelPoints"],
          "properties": {
            "playerId": { "type": "string" },
            "lockedAtLevelPoints": { "type": "integer", "enum": [10, 8, 6, 4, 2] },
            "answerText": { "type": "string", "description": "Only visible to HOST projection" },
            "remainingClues": { "type": "boolean", "description": "If true, game continues to next clue level" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "DESTINATION_REVEAL",
      "description": "Server → All: Reveal correct destination answer",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "DESTINATION_REVEAL" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["destinationName", "country"],
          "properties": {
            "destinationName": { "type": "string" },
            "country": { "type": "string" },
            "aliases": { "type": "array", "items": { "type": "string" }, "description": "Accepted alternative names" },
            "revealDelayMs": { "type": "integer", "description": "UI animation timing hint", "default": 1500 }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "DESTINATION_RESULTS",
      "description": "Server → All: Show who was right/wrong with points awarded",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "DESTINATION_RESULTS" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["results"],
          "properties": {
            "results": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["playerId", "playerName", "answerText", "isCorrect", "pointsAwarded", "lockedAtLevelPoints"],
                "properties": {
                  "playerId": { "type": "string" },
                  "playerName": { "type": "string" },
                  "answerText": { "type": "string" },
                  "isCorrect": { "type": "boolean" },
                  "pointsAwarded": { "type": "integer" },
                  "lockedAtLevelPoints": { "type": "integer", "enum": [10, 8, 6, 4, 2] }
                }
              }
            }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "SCOREBOARD_UPDATE",
      "description": "Server → All: Updated standings after round",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "SCOREBOARD_UPDATE" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["scoreboard"],
          "properties": {
            "scoreboard": {
              "type": "array",
              "description": "Sorted by score descending",
              "items": {
                "type": "object",
                "required": ["playerId", "name", "score"],
                "properties": {
                  "playerId": { "type": "string" },
                  "name": { "type": "string" },
                  "score": { "type": "integer" },
                  "rank": { "type": "integer", "description": "1-indexed rank (ties share rank)" }
                }
              }
            },
            "isGameOver": { "type": "boolean", "description": "True if this is the final scoreboard" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "FINAL_RESULTS_PRESENT",
      "description": "Server → All: Winner reveal and final standings (Sprint 1.1)",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "FINAL_RESULTS_PRESENT" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["isTie", "scoreboard"],
          "properties": {
            "isTie": { "type": "boolean" },
            "winnerPlayerId": { "type": "string", "description": "Single winner (null if tie)" },
            "tieWinners": {
              "type": "array",
              "description": "Multiple winners if tie",
              "items": {
                "type": "object",
                "required": ["playerId", "name", "score"],
                "properties": {
                  "playerId": { "type": "string" },
                  "name": { "type": "string" },
                  "score": { "type": "integer" }
                }
              }
            },
            "standingsTop3": {
              "type": "array",
              "description": "Top 3 for podium display",
              "maxItems": 3,
              "items": {
                "type": "object",
                "required": ["playerId", "name", "score", "rank"],
                "properties": {
                  "playerId": { "type": "string" },
                  "name": { "type": "string" },
                  "score": { "type": "integer" },
                  "rank": { "type": "integer" }
                }
              }
            },
            "scoreboard": {
              "type": "array",
              "description": "Full standings",
              "items": {
                "type": "object",
                "required": ["playerId", "name", "score", "rank"],
                "properties": {
                  "playerId": { "type": "string" },
                  "name": { "type": "string" },
                  "score": { "type": "integer" },
                  "rank": { "type": "integer" }
                }
              }
            },
            "timelineStartMs": { "type": "integer", "description": "Server time for 10-12s finale timeline sync" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "MUSIC_SET",
      "description": "Server → TV: Start playing background music (Sprint 1.1)",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "MUSIC_SET" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["trackId", "mode", "startAtServerMs"],
          "properties": {
            "trackId": { "type": "string", "description": "e.g. music_travel_loop" },
            "mode": { "type": "string", "enum": ["loop", "once"], "default": "loop" },
            "startAtServerMs": { "type": "integer", "description": "Sync point for playback start" },
            "gainDb": { "type": "number", "minimum": -40, "maximum": 6, "default": 0 },
            "fadeInMs": { "type": "integer", "minimum": 0, "default": 300 }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "MUSIC_STOP",
      "description": "Server → TV: Stop background music (Sprint 1.1)",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "MUSIC_STOP" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "properties": {
            "fadeOutMs": { "type": "integer", "minimum": 0, "default": 600 }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "MUSIC_GAIN_SET",
      "description": "Server → TV: Adjust music volume (Sprint 1.1)",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "MUSIC_GAIN_SET" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["gainDb"],
          "properties": {
            "gainDb": { "type": "number", "minimum": -40, "maximum": 6 },
            "transitionMs": { "type": "integer", "minimum": 0, "default": 300 }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "SFX_PLAY",
      "description": "Server → TV: Play sound effect (Sprint 1.1)",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "SFX_PLAY" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["sfxId", "startAtServerMs"],
          "properties": {
            "sfxId": { "type": "string", "description": "e.g. sfx_brake, sfx_lock, sfx_reveal, sfx_sting_build, sfx_drumroll, sfx_winner_fanfare" },
            "startAtServerMs": { "type": "integer", "description": "Sync point for playback" },
            "volume": { "type": "number", "minimum": 0, "maximum": 1, "default": 1.0 }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "UI_EFFECT_TRIGGER",
      "description": "Server → TV: Trigger visual effect (Sprint 1.1)",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "UI_EFFECT_TRIGGER" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["effectId"],
          "properties": {
            "effectId": { "type": "string", "enum": ["confetti", "flash", "spotlight"] },
            "intensity": { "type": "string", "enum": ["low", "med", "high"], "default": "med" },
            "durationMs": { "type": "integer", "minimum": 0, "default": 2500 },
            "params": { "type": "object", "description": "Effect-specific parameters" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "HOST_MUSIC_GAIN_SET",
      "description": "Host → Server: Adjust music volume (Sprint 1.1)",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "HOST_MUSIC_GAIN_SET" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["gainDb"],
          "properties": {
            "gainDb": { "type": "number", "minimum": -40, "maximum": 6 }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "FOLLOWUP_QUESTION_PRESENT",
      "description": "Server → All: Present a follow-up question after destination reveal. Timer starts server-side at serverTimeMs.",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "FOLLOWUP_QUESTION_PRESENT" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["questionText", "currentQuestionIndex", "totalQuestions", "timerDurationMs"],
          "properties": {
            "questionText": { "type": "string", "description": "The question shown to all players" },
            "options": {
              "type": ["array", "null"],
              "description": "Multiple-choice options. null = open-text answer.",
              "items": { "type": "string" }
            },
            "currentQuestionIndex": { "type": "integer", "minimum": 0, "description": "0-indexed position in the followup sequence" },
            "totalQuestions": { "type": "integer", "minimum": 1, "description": "Total follow-up questions for this destination" },
            "timerDurationMs": { "type": "integer", "minimum": 1000, "description": "Countdown duration. Server locks answers at serverTimeMs + timerDurationMs." },
            "correctAnswer": { "type": "string", "description": "HOST projection only — never sent to TV or PLAYER" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "FOLLOWUP_ANSWER_SUBMIT",
      "description": "Player → Server: Submit answer to current follow-up question. Ignored after timer expiry.",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "FOLLOWUP_ANSWER_SUBMIT" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["playerId", "answerText"],
          "properties": {
            "playerId": { "type": "string" },
            "answerText": { "type": "string", "minLength": 1, "maxLength": 200, "description": "Selected option text (MC) or free-text answer" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "FOLLOWUP_ANSWERS_LOCKED",
      "description": "Server → All: Timer expired, all answers are locked. Sent before results. Payload is role-projected: HOST sees answersByPlayer, TV and PLAYER do not.",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "FOLLOWUP_ANSWERS_LOCKED" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["currentQuestionIndex", "lockedPlayerCount"],
          "properties": {
            "currentQuestionIndex": { "type": "integer", "minimum": 0 },
            "lockedPlayerCount": { "type": "integer", "minimum": 0, "description": "How many players submitted before timeout" },
            "answersByPlayer": {
              "type": "array",
              "description": "HOST projection only — never sent to TV or PLAYER.",
              "items": {
                "type": "object",
                "required": ["playerId", "playerName", "answerText"],
                "properties": {
                  "playerId": { "type": "string" },
                  "playerName": { "type": "string" },
                  "answerText": { "type": "string" }
                }
              }
            }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "FOLLOWUP_RESULTS",
      "description": "Server → All: Reveal correct answer and per-player scoring for one follow-up question. Sent to all roles with identical payload (correctAnswer is now public).",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "FOLLOWUP_RESULTS" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["currentQuestionIndex", "correctAnswer", "results"],
          "properties": {
            "currentQuestionIndex": { "type": "integer", "minimum": 0 },
            "correctAnswer": { "type": "string", "description": "The correct answer — now public for all roles" },
            "results": {
              "type": "array",
              "description": "Per-player outcome. Sorted by playerId for deterministic rendering.",
              "items": {
                "type": "object",
                "required": ["playerId", "playerName", "answerText", "isCorrect", "pointsAwarded"],
                "properties": {
                  "playerId": { "type": "string" },
                  "playerName": { "type": "string" },
                  "answerText": { "type": "string", "description": "Empty string if player did not submit before timeout" },
                  "isCorrect": { "type": "boolean" },
                  "pointsAwarded": { "type": "integer", "minimum": 0, "description": "+2 if correct, 0 otherwise (scoring.md)" }
                }
              }
            },
            "nextQuestionIndex": { "type": ["integer", "null"], "description": "Index of next followup, or null if this was the last one" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "AUDIO_PLAY",
      "description": "Server → TV: Play a pre-generated TTS voice clip. Automatically triggers music-bed ducking (−10 dB, 150 ms attack, 900 ms release). No explicit AUDIO_DUCK event exists — ducking is a deterministic side-effect of this event.",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "AUDIO_PLAY" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["clipId", "url", "durationMs", "startAtServerMs", "text"],
          "properties": {
            "clipId": { "type": "string", "description": "Unique clip ID from TTS manifest (e.g. banter_after_brake_002_round_abc123)" },
            "url": { "type": "string", "format": "uri", "description": "Cache URL for the M4A clip" },
            "durationMs": { "type": "integer", "minimum": 100, "description": "Clip duration in ms" },
            "startAtServerMs": { "type": "integer", "description": "Server time sync point; TV compensates via WELCOME offset" },
            "text": { "type": "string", "description": "Swedish text of the clip — always included as subtitle fallback" },
            "showText": { "type": "boolean", "default": false, "description": "If true, TV shows text overlay while clip plays" },
            "volume": { "type": "number", "minimum": 0.0, "maximum": 2.0, "default": 1.0, "description": "Playback volume multiplier. 1.0 = nominal TTS level; values > 1.0 amplify (e.g. 1.4 for boosted TTS). Range intentionally wider than SFX_PLAY to support voice-level tuning." }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "AUDIO_STOP",
      "description": "Server → TV: Stop the currently playing voice clip early (e.g. interrupted by a higher-priority event). Music ducking release begins immediately (900 ms envelope).",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "AUDIO_STOP" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["clipId"],
          "properties": {
            "clipId": { "type": "string", "description": "Clip to stop. Empty string = stop any active voice clip." },
            "fadeOutMs": { "type": "integer", "minimum": 0, "default": 150, "description": "Voice fade-out duration before hard stop" }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "TTS_PREFETCH",
      "description": "Server → TV: Pre-download upcoming TTS clips so AUDIO_PLAY can start with zero fetch latency. No audio plays; no ducking occurs. Sent ahead of the game moment that will use the clip.",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "TTS_PREFETCH" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["clips"],
          "properties": {
            "clips": {
              "type": "array",
              "description": "Batch of clips to prefetch (1-8 per event)",
              "minItems": 1,
              "maxItems": 8,
              "items": {
                "type": "object",
                "required": ["clipId", "url", "durationMs"],
                "properties": {
                  "clipId": { "type": "string" },
                  "url": { "type": "string", "format": "uri" },
                  "durationMs": { "type": "integer", "minimum": 100 }
                },
                "additionalProperties": false
              }
            }
          },
          "additionalProperties": false
        }
      }
    },

    {
      "title": "ERROR",
      "description": "Server → Client: Error notification",
      "type": "object",
      "required": ["type", "sessionId", "serverTimeMs", "payload"],
      "properties": {
        "type": { "const": "ERROR" },
        "sessionId": { "type": "string" },
        "serverTimeMs": { "type": "integer" },
        "payload": {
          "type": "object",
          "required": ["errorCode", "message"],
          "properties": {
            "errorCode": { "type": "string", "enum": ["INVALID_SESSION", "UNAUTHORIZED", "RATE_LIMITED", "INVALID_PHASE", "VALIDATION_ERROR", "INTERNAL_ERROR"] },
            "message": { "type": "string" },
            "details": { "type": "object" }
          },
          "additionalProperties": false
        }
      }
    }
  ]
}
