{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "På Spåret Party Edition - Game State v1.3.0",
  "description": "Complete game state structure for Sprint 1, Sprint 1.1 (audio), Sprint 1.2 (follow-up questions), and Sprint 1.3 (TTS voice)",
  "type": "object",
  "required": ["version", "phase", "sessionId", "joinCode", "players", "scoreboard"],
  "properties": {
    "version": {
      "type": "integer",
      "description": "State schema version"
    },
    "phase": {
      "type": "string",
      "enum": [
        "LOBBY",
        "PREPARING_ROUND",
        "ROUND_INTRO",
        "CLUE_LEVEL",
        "PAUSED_FOR_BRAKE",
        "REVEAL_DESTINATION",
        "FOLLOWUP_QUESTION",
        "SCOREBOARD",
        "FINAL_RESULTS",
        "ROUND_END"
      ],
      "description": "Current game phase"
    },
    "sessionId": {
      "type": "string",
      "description": "Unique session identifier"
    },
    "joinCode": {
      "type": "string",
      "description": "4-6 character code for players to join"
    },
    "players": {
      "type": "array",
      "description": "All players in the session",
      "items": {
        "type": "object",
        "required": ["playerId", "name", "role", "isConnected", "joinedAtMs", "score"],
        "properties": {
          "playerId": { "type": "string" },
          "name": { "type": "string" },
          "role": { "type": "string", "enum": ["PLAYER", "HOST", "TV"] },
          "isConnected": { "type": "boolean" },
          "joinedAtMs": { "type": "integer" },
          "score": { "type": "integer", "minimum": 0 }
        },
        "additionalProperties": false
      }
    },
    "roundIndex": {
      "type": "integer",
      "description": "0-indexed round number",
      "minimum": 0
    },
    "destination": {
      "type": "object",
      "description": "Current destination (role-aware projection)",
      "properties": {
        "name": {
          "type": ["string", "null"],
          "description": "Correct answer - HOST only until reveal"
        },
        "country": {
          "type": ["string", "null"],
          "description": "Destination country - HOST only until reveal"
        },
        "aliases": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Accepted alternative names - HOST only until reveal"
        },
        "revealed": {
          "type": "boolean",
          "description": "True after DESTINATION_REVEAL"
        }
      },
      "additionalProperties": false
    },
    "clueLevelPoints": {
      "type": ["integer", "null"],
      "enum": [10, 8, 6, 4, 2, null],
      "description": "Current clue level point value"
    },
    "clueText": {
      "type": ["string", "null"],
      "description": "Current clue text being displayed"
    },
    "brakeOwnerPlayerId": {
      "type": ["string", "null"],
      "description": "Player who has the brake (in PAUSED_FOR_BRAKE phase)"
    },
    "lockedAnswers": {
      "type": "array",
      "description": "All submitted answers (role-aware projection)",
      "items": {
        "type": "object",
        "required": ["playerId", "answerText", "lockedAtLevelPoints", "lockedAtMs"],
        "properties": {
          "playerId": { "type": "string" },
          "answerText": {
            "type": "string",
            "description": "Answer text - HOST sees all, PLAYER sees only own, TV sees count only"
          },
          "lockedAtLevelPoints": { "type": "integer", "enum": [10, 8, 6, 4, 2] },
          "lockedAtMs": { "type": "integer" },
          "isCorrect": {
            "type": "boolean",
            "description": "Only present after DESTINATION_REVEAL"
          },
          "pointsAwarded": {
            "type": "integer",
            "description": "Only present after DESTINATION_REVEAL"
          }
        },
        "additionalProperties": false
      }
    },
    "followupQuestion": {
      "type": ["object", "null"],
      "description": "Active follow-up question state. Present only during FOLLOWUP_QUESTION phase; null otherwise. Fields marked HOST-only are stripped by projectState for TV and PLAYER.",
      "properties": {
        "questionText": {
          "type": "string",
          "description": "Question text shown to all roles"
        },
        "options": {
          "type": ["array", "null"],
          "description": "Multiple-choice options. null = open-text.",
          "items": { "type": "string" }
        },
        "currentQuestionIndex": {
          "type": "integer",
          "minimum": 0,
          "description": "0-indexed position in the followup sequence for this destination"
        },
        "totalQuestions": {
          "type": "integer",
          "minimum": 1,
          "description": "Total follow-up questions for this destination"
        },
        "correctAnswer": {
          "type": ["string", "null"],
          "description": "Correct answer — HOST projection only. null in TV and PLAYER STATE_SNAPSHOT until FOLLOWUP_RESULTS is sent."
        },
        "answersByPlayer": {
          "type": "array",
          "description": "Per-player submitted answers — HOST projection only. Empty array in TV and PLAYER STATE_SNAPSHOT.",
          "items": {
            "type": "object",
            "required": ["playerId", "playerName", "answerText"],
            "properties": {
              "playerId": { "type": "string" },
              "playerName": { "type": "string" },
              "answerText": { "type": "string" }
            }
          }
        },
        "timer": {
          "type": ["object", "null"],
          "description": "Server-side countdown for this question. Reuses the top-level timer shape.",
          "properties": {
            "timerId": { "type": "string" },
            "startAtServerMs": { "type": "integer" },
            "durationMs": { "type": "integer", "minimum": 1000 }
          },
          "required": ["timerId", "startAtServerMs", "durationMs"],
          "additionalProperties": false
        },
        "answeredByMe": {
          "type": "boolean",
          "description": "PLAYER projection helper: true if this player has already submitted for this question. Not present in HOST or TV projection."
        }
      },
      "required": ["questionText", "currentQuestionIndex", "totalQuestions", "correctAnswer", "answersByPlayer", "timer"],
      "additionalProperties": false
    },
    "scoreboard": {
      "type": "array",
      "description": "Current standings (sorted by score descending)",
      "items": {
        "type": "object",
        "required": ["playerId", "name", "score"],
        "properties": {
          "playerId": { "type": "string" },
          "name": { "type": "string" },
          "score": { "type": "integer", "minimum": 0 },
          "rank": {
            "type": "integer",
            "minimum": 1,
            "description": "1-indexed rank (ties share rank)"
          }
        },
        "additionalProperties": false
      }
    },
    "timer": {
      "type": ["object", "null"],
      "description": "Active server-side timer",
      "properties": {
        "timerId": { "type": "string" },
        "startAtServerMs": { "type": "integer" },
        "durationMs": { "type": "integer", "minimum": 0 }
      },
      "required": ["timerId", "startAtServerMs", "durationMs"],
      "additionalProperties": false
    },
    "audioState": {
      "type": "object",
      "description": "Audio playback state. Projection: HOST sees all fields; TV sees all except ttsManifest; PLAYER omitted entirely. See projections.md §Audio State Projection.",
      "properties": {
        "currentTrackId": { "type": ["string", "null"], "description": "Currently playing music track ID, or null when music is silent" },
        "isPlaying": { "type": "boolean", "description": "Whether the music bed is actively playing" },
        "gainDb": { "type": "number", "minimum": -40, "maximum": 6, "description": "Current music bed gain; host override survives reconnect" },
        "activeVoiceClip": {
          "type": ["object", "null"],
          "description": "Currently playing TTS voice clip, or null. On reconnect tvOS compares startAtServerMs + durationMs against now to decide resume vs skip.",
          "properties": {
            "clipId": { "type": "string" },
            "url": { "type": "string", "format": "uri" },
            "startAtServerMs": { "type": "integer" },
            "durationMs": { "type": "integer" },
            "text": { "type": "string" }
          },
          "required": ["clipId", "url", "startAtServerMs", "durationMs", "text"],
          "additionalProperties": false
        },
        "ttsManifest": {
          "type": "array",
          "description": "HOST projection only — full pre-gen manifest for the current round. Omitted for TV and PLAYER. Monitoring / debug use.",
          "items": {
            "type": "object",
            "required": ["clipId", "phraseId", "url", "durationMs"],
            "properties": {
              "clipId": { "type": "string" },
              "phraseId": { "type": "string", "description": "Reference to banter.md phrase ID" },
              "url": { "type": "string", "format": "uri" },
              "durationMs": { "type": "integer" },
              "generatedAtMs": { "type": "integer", "description": "Epoch ms when the clip was generated" }
            },
            "additionalProperties": false
          }
        }
      },
      "required": ["currentTrackId", "isPlaying", "gainDb"],
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
